#!/usr/bin/env bash
set -e
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "${BASEDIR}"

# Colors
CYAN='\033[36m' GREEN='\033[32m' YELLOW='\033[33m' RED='\033[31m'
BOLD='\033[1m' DIM='\033[2m' RESET='\033[0m'

header() { echo -e "\n${BOLD}${CYAN}$1${RESET}"; }
ok() { echo -e "${GREEN}✓ $1${RESET}"; }
warn() { echo -e "${YELLOW}⚠ $1${RESET}"; }
run() { echo -e "${DIM}\$ $*${RESET}"; "$@"; }
has() { command -v "$1" &>/dev/null; }

echo -e "\n${BOLD}${CYAN}Dotfiles Installation${RESET}"

# --- System packages (Linux only) ---
if [[ "$(uname)" == "Linux" ]] && has apt; then
    has nala || {
        header "Installing nala..."
        sudo -v
        run sudo apt update
        run sudo apt install -y nala
    }
    # Check if key packages missing before running install
    if ! has zsh || ! has neovim || ! has jq; then
        header "Installing system packages..."
        sudo -v
        run sudo nala install -y build-essential gcc g++ make procps file \
            zsh bash git curl wget neovim htop tree jq python3 python3-pip \
            ddcutil i2c-tools
    else
        ok "System packages already installed"
    fi
fi

# --- Homebrew ---
if ! has brew; then
    header "Installing Homebrew..."
    bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi
# Source brew for this session
if [[ "$(uname)" == "Darwin" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
else
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
ok "Homebrew ready"

# --- Homebrew packages ---
# Check if key packages missing before running install
if ! has fzf || ! has starship || ! has eza; then
    header "Installing Homebrew packages..."
    [[ "$(uname)" == "Darwin" ]] && run brew install git curl wget neovim htop tree jq
    run brew install fzf zoxide starship eza bat ripgrep fd gh helix pre-commit uv ruff stylua
    run brew install font-cascadia-code font-iosevka font-symbols-only-nerd-font || true
else
    ok "Homebrew packages already installed"
fi

# --- Rust ---
has rustc && ok "Rust already installed" || {
    header "Installing Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
}

# --- Bun ---
has bun && ok "Bun already installed" || {
    header "Installing Bun..."
    curl -fsSL https://bun.sh/install | bash
}

# --- Check Python/Node ---
has python3 && ok "Python installed" || warn "Python not found"
has node && ok "Node.js installed" || warn "Node.js not found (install via nvm)"

# --- SourceCodeVF font ---
FONT_URL="https://github.com/adobe-fonts/source-code-pro/releases/download/2.042R-u%2F1.062R-i%2F1.026R-vf/VF-source-code-VF-1.026R.zip"
if [[ "$(uname)" == "Linux" ]]; then
    FONT_DIR="$HOME/.local/share/fonts"
else
    FONT_DIR="$HOME/Library/Fonts"
fi
if fc-list 2>/dev/null | grep -q "SourceCodeVF"; then
    ok "SourceCodeVF font installed"
else
    header "Installing SourceCodeVF font..."
    mkdir -p "$FONT_DIR"
    TMP=$(mktemp -d)
    curl -sL "$FONT_URL" -o "$TMP/font.zip"
    unzip -q "$TMP/font.zip" -d "$TMP"
    find "$TMP" -name "*.otf" -o -name "*.ttf" | xargs -I{} cp {} "$FONT_DIR/"
    rm -rf "$TMP"
    has fc-cache && fc-cache -f
    ok "SourceCodeVF font installed"
fi

# --- Dotbot (symlinks) ---
header "Setting up symlinks..."
git -C dotbot submodule sync --quiet --recursive
git submodule update --init --recursive dotbot
"${BASEDIR}/dotbot/bin/dotbot" -d "${BASEDIR}" -c "install.conf.yaml" "$@"

echo -e "\n${BOLD}${GREEN}✓ Installation complete!${RESET}\n"
