#!/bin/sh
set -e
BASEDIR="$(cd "$(dirname "$0")" && pwd)"
cd "${BASEDIR}"

# Colors
Red="$(printf '\033[31m')"
Green="$(printf '\033[32m')"
Yellow="$(printf '\033[33m')"
Cyan="$(printf '\033[36m')"
Bold="$(printf '\033[1m')"
Dim="$(printf '\033[2m')"
Reset="$(printf '\033[0m')"

header() { printf "\n%b\n" "${Bold}${Cyan}$1${Reset}"; }
ok() { printf "%b\n" "${Green}✓ $1${Reset}"; }
warn() { printf "%b\n" "${Yellow}⚠ $1${Reset}"; }
run() {
    printf "%b\n" "${Dim}\$ $*${Reset}"
    "$@"
}
has() { command -v "$1" &>/dev/null; }
usage() {
    cat <<'EOF'
Usage: install [options] [dotbot args]

Options:
  -h, --help     Show this help and exit

Environment:
  NERDIFY=1      Enable Nerd Fonts patching for Consolas
EOF
}

for arg in "$@"; do
    case "$arg" in
        -h|--help)
            usage
            exit 0
            ;;
    esac
done
report_brew_bundle() {
    brewfile="$1"
    tmp_formula="$(mktemp)"
    tmp_cask="$(mktemp)"
    brew list --versions >"$tmp_formula"
    brew list --cask --versions >"$tmp_cask"

    while IFS= read -r line; do
        case "$line" in
        brew\ \"*\")
            name="${line#*\"}"
            name="${name%%\"*}"
            version="$(awk -v n="$name" '$1==n{print $2}' "$tmp_formula")"
            if [ -n "$version" ]; then
                ok "$name installed ($version)"
            else
                warn "$name not installed"
            fi
            ;;
        cask\ \"*\")
            name="${line#*\"}"
            name="${name%%\"*}"
            version="$(awk -v n="$name" '$1==n{print $2}' "$tmp_cask")"
            if [ -n "$version" ]; then
                ok "$name installed ($version)"
            else
                warn "$name not installed"
            fi
            ;;
        esac
    done <"$brewfile"

    rm -f "$tmp_formula" "$tmp_cask"
}

printf "\n%b\n" "${Bold}${Cyan}Dotfiles Installation${Reset}"

# System packages (Linux only)
if [ "$(uname)" = "Linux" ] && has apt; then
    has nala || {
        header "Installing nala..."
        sudo -v
        run sudo apt update
        run sudo apt install -y nala
    }
    # Check if key packages missing before running install
    if ! has zsh || ! has neovim || ! has jq; then
        header "Installing system packages..."
        sudo -v
        run sudo nala install -y build-essential gcc g++ make procps file \
            zsh bash git curl wget neovim htop tree jq python3 python3-pip \
            ddcutil i2c-tools
    else
        ok "System packages already installed"
    fi
fi

# Homebrew
if ! has brew; then
    header "Installing Homebrew..."
    bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi
# Source brew for this session
if [ "$(uname)" = "Darwin" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
else
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
ok "Homebrew ready"

# Homebrew packages
if [ -f "${BASEDIR}/Brewfile" ]; then
    header "Installing Homebrew bundle..."
    run brew bundle --file "${BASEDIR}/Brewfile"
    header "Homebrew package versions"
    report_brew_bundle "${BASEDIR}/Brewfile"
else
    warn "Brewfile not found; skipping Homebrew bundle"
fi

# Rust
has rustc && ok "Rust already installed" || {
    header "Installing Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    . "$HOME/.cargo/env"
}

# Bun
has bun && ok "Bun already installed" || {
    header "Installing Bun..."
    curl -fsSL https://bun.sh/install | bash
}

# Check Python/Node
has python3 && ok "Python installed" || warn "Python not found"
has node && ok "Node.js installed" || warn "Node.js not found (install via system packages or nvm)"

# Opencode
has opencode && ok "Opencode installed" || {
    header "Installing Opencode..."
    if has clang || has gcc; then
        run brew install anomalyco/tap/opencode
    else
        warn "Opencode needs a compiler (clang or gcc); install via system packages, then rerun"
    fi
}

# pre-commit
if has uv; then
    has pre-commit && ok "pre-commit installed" || {
        header "Installing pre-commit (uv)..."
        run uv tool install pre-commit
    }
else
    warn "uv not found; skipping pre-commit install"
fi

# Selawik font
FONT_URL="https://github.com/microsoft/Selawik/releases/download/1.01/Selawik_Release.zip"
if [ "$(uname)" = "Linux" ]; then
    FONT_DIR="$HOME/.local/share/fonts"
else
    FONT_DIR="$HOME/Library/Fonts"
fi
if fc-list 2>/dev/null | grep -q "Selawik"; then
    ok "Selawik font installed"
else
    header "Installing Selawik font..."
    mkdir -p "$FONT_DIR"
    TMP=$(mktemp -d)
    curl -sL "$FONT_URL" -o "$TMP/font.zip"
    unzip -q "$TMP/font.zip" -d "$TMP"
    find "$TMP" -name "*.otf" -o -name "*.ttf" | xargs -I{} cp {} "$FONT_DIR/"
    rm -rf "$TMP"
    has fc-cache && fc-cache -f
    ok "Selawik font installed"
fi

# Consolas fonts (ligaturized + nerdified)
CONSOLAS_REPO_URL="https://github.com/adityamwagh/consolas-nerd-font"
if [ "${NERDIFY:-}" = "1" ]; then
    CONSOLAS_VARIANT="Consolas LNF"
else
    CONSOLAS_VARIANT="Consolas L"
fi

CONSOLAS_TMP_DIR=""
if has git; then
    header "Fetching Consolas fonts..."
    CONSOLAS_TMP_DIR="$(mktemp -d)"
    run git clone --depth 1 "${CONSOLAS_REPO_URL}" "${CONSOLAS_TMP_DIR}"
else
    warn "git not found; skipping Consolas fonts"
fi

if [ -n "${CONSOLAS_TMP_DIR}" ]; then
    CONSOLAS_OUT_DIR="${CONSOLAS_TMP_DIR}/${CONSOLAS_VARIANT}"
    header "Installing ${CONSOLAS_VARIANT}..."
    mkdir -p "${FONT_DIR}"
    find "${CONSOLAS_OUT_DIR}" -maxdepth 1 -name "*.ttf" -exec cp {} "${FONT_DIR}/" \;
    has fc-cache && fc-cache -f
    ok "${CONSOLAS_VARIANT} installed"
fi

if [ -n "${CONSOLAS_TMP_DIR}" ]; then
    rm -rf "${CONSOLAS_TMP_DIR}"
fi

# Segoe UI (Linux)
if [ "$(uname)" = "Linux" ]; then
    SEGOE_URL="https://github.com/mrbvrz/segoe-ui-linux/archive/refs/heads/master.zip"
    if fc-list 2>/dev/null | grep -q "Segoe UI"; then
        ok "Segoe UI font installed"
    else
        header "Installing Segoe UI font..."
        mkdir -p "$FONT_DIR"
        TMP=$(mktemp -d)
        curl -sL "$SEGOE_URL" -o "$TMP/segoe.zip"
        unzip -q "$TMP/segoe.zip" -d "$TMP"
        find "$TMP" -name "*.otf" -o -name "*.ttf" | xargs -I{} cp {} "$FONT_DIR/"
        rm -rf "$TMP"
        has fc-cache && fc-cache -f
        ok "Segoe UI font installed"
    fi
fi

# Dotbot (symlinks)
header "Setting up symlinks..."
git -C dotbot submodule sync --quiet --recursive
git submodule update --init --recursive dotbot
"${BASEDIR}/dotbot/bin/dotbot" -d "${BASEDIR}" -c "install.conf.yaml" "$@"

printf "\n%b\n\n" "${Bold}${Green}✓ Installation complete!${Reset}"
